name: CI

on: [push]
jobs:
  Build_Linux:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-18.04 , ubuntu-16.04]
        toolkit: [10.1.105_418.39]
    steps:
      # - name: Cache Toolkit
        # id: cacheTK
        # uses: actions/cache@v1
       #  with:
          # path: /usr/local/cuda/
          # key: ${{ runner.os }}-${{ matrix.toolkit }}
        # Driver Install instructions: https://gist.github.com/wangruohui/df039f0dc434d6486f5d4d098aa52d07#install-nvidia-graphics-driver-via-runfile
        # Toolkit Runfile flags: https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#runfile-advanced
        # Toolkit Windows flags: https://docs.nvidia.com/cuda/cuda-installation-guide-microsoft-windows/index.html#install-cuda-software  
        #                        https://devtalk.nvidia.com/default/topic/984735/windows-cuda-toolkit-silent-installation-/
        # Toolkit Mac install flags: https://docs.nvidia.com/cuda/cuda-installation-guide-mac-os-x/index.html#install
      - name: Install Toolkit
        #if: steps.cacheTK.outputs.cache-hit != 'true'
        run: |
          TK_PATH="${{ matrix.toolkit }}"
          TK_VERSION="${TK_PATH:0:4}"
          echo "Toolkit path: $TK_PATH"
          echo "Toolkit version: $TK_VERSION"
          wget https://developer.nvidia.com/compute/cuda/${TK_VERSION}/Prod/local_installers/cuda_${TK_PATH}_linux.run
          sudo apt-get install build-essential
          chmod +x cuda_${TK_PATH}_linux.run 
          sudo ./cuda_${TK_PATH}_linux.run --silent --toolkit 
          
      - uses: actions/checkout@v2
     
      - name: Build 
        run: |
          # sudo apt install tree
          # tree /usr/
          echo Running -j "$(getconf _NPROCESSORS_ONLN)"
          mkdir -p build
          cmake -DCMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Release -S . -B build
          cmake --build build/ -j "$(getconf _NPROCESSORS_ONLN)"
        
      - name: Upload Build Artifact
        if: success()
        uses: actions/upload-artifact@v1
        with:
          name: Binaries-${{ matrix.os }}-${{ matrix.toolkit }}
          path: build/
          
      
  Build_Windows:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        toolkit: [10.2.89_441.22]
    steps:
      # - name: Cache Toolkit
        # id: cacheTK
        # uses: actions/cache@v1
       #  with:
          # path: /usr/local/cuda/
          # key: ${{ runner.os }}-${{ matrix.toolkit }}
        # Driver Install instructions: https://gist.github.com/wangruohui/df039f0dc434d6486f5d4d098aa52d07#install-nvidia-graphics-driver-via-runfile
        # Toolkit Runfile flags: https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#runfile-advanced
        # Toolkit Windows flags: https://docs.nvidia.com/cuda/cuda-installation-guide-microsoft-windows/index.html#install-cuda-software  
        #                        https://devtalk.nvidia.com/default/topic/984735/windows-cuda-toolkit-silent-installation-/
        # Toolkit Mac install flags: https://docs.nvidia.com/cuda/cuda-installation-guide-mac-os-x/index.html#install
      - name: Install Toolkit
        shell: bash
        #if: steps.cacheTK.outputs.cache-hit != 'true'
        run: |
          TK_PATH="${{ matrix.toolkit }}"
          TK_VERSION="${TK_PATH:0:4}"
          echo "Toolkit path: $TK_PATH"
          echo "Toolkit version: $TK_VERSION"
          wget https://developer.nvidia.com/compute/cuda/${TK_VERSION}/Prod/local_installers/cuda_${TK_PATH}_linux.run
          sudo apt-get install build-essential
          chmod +x cuda_${TK_PATH}_linux.run 
          sudo ./cuda_${TK_PATH}_linux.run --silent --toolkit 
          
      - uses: actions/checkout@v2
     
      - name: Build 
        shell: bash
        run: |
          # sudo apt install tree
          # tree /usr/
          echo Running -j "$(getconf _NPROCESSORS_ONLN)"
          mkdir -p build
          cmake -DCMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc -DCMAKE_EXPORT_COMPILE_COMMANDS=ON -DCMAKE_BUILD_TYPE=Release -S . -B build
          cmake --build build/ -j "$(getconf _NPROCESSORS_ONLN)"
        
      - name: Upload Build Artifact
        if: success()
        uses: actions/upload-artifact@v1
        with:
          name: Binaries-${{ matrix.os }}-${{ matrix.toolkit }}
          path: build/
